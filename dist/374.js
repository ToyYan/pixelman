exports.id=374,exports.ids=[374],exports.modules={981:(e,t,s)=>{"use strict";var r=s(6423),i=s(1365);function a(e){if("string"==typeof e&&"j:"===e.substr(0,2))try{return JSON.parse(e.slice(2))}catch(e){return}}function n(e){for(var t,s,r=Object.keys(e),i=0;i<r.length;i++)(s=a(e[t=r[i]]))&&(e[t]=s);return e}function o(e,t){if("string"==typeof e){if("s:"!==e.substr(0,2))return e;for(var s=!t||Array.isArray(t)?t||[]:[t],r=0;r<s.length;r++){var a=i.unsign(e.slice(2),s[r]);if(!1!==a)return a}return!1}}function d(e,t){for(var s,r,i,a=Object.keys(e),n=Object.create(null),d=0;d<a.length;d++)(i=e[r=a[d]])!==(s=o(i,t))&&(n[r]=s,delete e[r]);return n}e.exports=function(e,t){var s=!e||Array.isArray(e)?e||[]:[e];return function(e,i,a){if(e.cookies)return a();var o=e.headers.cookie;if(e.secret=s[0],e.cookies=Object.create(null),e.signedCookies=Object.create(null),!o)return a();e.cookies=r.parse(o,t),0!==s.length&&(e.signedCookies=d(e.cookies,s),e.signedCookies=n(e.signedCookies)),e.cookies=n(e.cookies),a()}},e.exports.JSONCookie=a,e.exports.JSONCookies=n,e.exports.signedCookie=o,e.exports.signedCookies=d},6423:(e,t)=>{"use strict";t.parse=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var r={},a=t||{},o=e.split(i),d=a.decode||s,l=0;l<o.length;l++){var c=o[l],p=c.indexOf("=");if(!(p<0)){var h=c.substr(0,p).trim(),u=c.substr(++p,c.length).trim();'"'==u[0]&&(u=u.slice(1,-1)),null==r[h]&&(r[h]=n(u,d))}}return r},t.serialize=function(e,t,s){var i=s||{},n=i.encode||r;if("function"!=typeof n)throw new TypeError("option encode is invalid");if(!a.test(e))throw new TypeError("argument name is invalid");var o=n(t);if(o&&!a.test(o))throw new TypeError("argument val is invalid");var d=e+"="+o;if(null!=i.maxAge){var l=i.maxAge-0;if(isNaN(l)||!isFinite(l))throw new TypeError("option maxAge is invalid");d+="; Max-Age="+Math.floor(l)}if(i.domain){if(!a.test(i.domain))throw new TypeError("option domain is invalid");d+="; Domain="+i.domain}if(i.path){if(!a.test(i.path))throw new TypeError("option path is invalid");d+="; Path="+i.path}if(i.expires){if("function"!=typeof i.expires.toUTCString)throw new TypeError("option expires is invalid");d+="; Expires="+i.expires.toUTCString()}i.httpOnly&&(d+="; HttpOnly");i.secure&&(d+="; Secure");if(i.sameSite){switch("string"==typeof i.sameSite?i.sameSite.toLowerCase():i.sameSite){case!0:d+="; SameSite=Strict";break;case"lax":d+="; SameSite=Lax";break;case"strict":d+="; SameSite=Strict";break;case"none":d+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return d};var s=decodeURIComponent,r=encodeURIComponent,i=/; */,a=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function n(e,t){try{return t(e)}catch(t){return e}}},1365:(e,t,s)=>{var r=s(6113);function i(e){return r.createHash("sha1").update(e).digest("hex")}t.sign=function(e,t){if("string"!=typeof e)throw new TypeError("Cookie value must be provided as a string.");if("string"!=typeof t)throw new TypeError("Secret string must be provided.");return e+"."+r.createHmac("sha256",t).update(e).digest("base64").replace(/\=+$/,"")},t.unsign=function(e,s){if("string"!=typeof e)throw new TypeError("Signed cookie string must be provided.");if("string"!=typeof s)throw new TypeError("Secret string must be provided.");var r=e.slice(0,e.lastIndexOf("."));return i(t.sign(r,s))==i(e)&&r}},6489:(e,t)=>{"use strict";t.parse=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");var s={},r=(t||{}).decode||i,a=0;for(;a<e.length;){var o=e.indexOf("=",a);if(-1===o)break;var d=e.indexOf(";",a);if(-1===d)d=e.length;else if(d<o){a=e.lastIndexOf(";",o-1)+1;continue}var l=e.slice(a,o).trim();if(void 0===s[l]){var c=e.slice(o+1,d).trim();34===c.charCodeAt(0)&&(c=c.slice(1,-1)),s[l]=n(c,r)}a=d+1}return s},t.serialize=function(e,t,i){var n=i||{},o=n.encode||a;if("function"!=typeof o)throw new TypeError("option encode is invalid");if(!r.test(e))throw new TypeError("argument name is invalid");var d=o(t);if(d&&!r.test(d))throw new TypeError("argument val is invalid");var l=e+"="+d;if(null!=n.maxAge){var c=n.maxAge-0;if(isNaN(c)||!isFinite(c))throw new TypeError("option maxAge is invalid");l+="; Max-Age="+Math.floor(c)}if(n.domain){if(!r.test(n.domain))throw new TypeError("option domain is invalid");l+="; Domain="+n.domain}if(n.path){if(!r.test(n.path))throw new TypeError("option path is invalid");l+="; Path="+n.path}if(n.expires){var p=n.expires;if(!function(e){return"[object Date]"===s.call(e)||e instanceof Date}(p)||isNaN(p.valueOf()))throw new TypeError("option expires is invalid");l+="; Expires="+p.toUTCString()}n.httpOnly&&(l+="; HttpOnly");n.secure&&(l+="; Secure");if(n.priority){switch("string"==typeof n.priority?n.priority.toLowerCase():n.priority){case"low":l+="; Priority=Low";break;case"medium":l+="; Priority=Medium";break;case"high":l+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}}if(n.sameSite){switch("string"==typeof n.sameSite?n.sameSite.toLowerCase():n.sameSite){case!0:l+="; SameSite=Strict";break;case"lax":l+="; SameSite=Lax";break;case"strict":l+="; SameSite=Strict";break;case"none":l+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return l};var s=Object.prototype.toString,r=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function i(e){return-1!==e.indexOf("%")?decodeURIComponent(e):e}function a(e){return encodeURIComponent(e)}function n(e,t){try{return t(e)}catch(t){return e}}},4374:(e,t,s)=>{"use strict";s.r(t);var r=s(3566),i=s.n(r),a=s(981),n=s.n(a),o=s(3685),d=s(1017),l=s(5473);const c=class{config;app;http;constructor(e){this.config=e;const{httpPort:t,httpHost:s}=this.config,r=this.app=i()();r.use(n()()),r.use("*",((e,t,s)=>{let r=e.cookies.renderId;r||(r=Math.random().toString(36).slice(2)),t.cookie("renderId",r,{maxAge:6048e5}),s()})),e.enableFrontend&&r.use(i().static((0,d.join)(__dirname,"../public"))),e.enableDashboard&&r.use("/dashboard/",i().static((0,d.join)(__dirname,"../public/dashboard/"))),this.http=new o.Server(this.app),this.http.listen(t,s,(()=>{l.Z.info(`HttpServer listening on ${s||"*"}:${t}`),l.Z.info(`player page: http://${s}:${t}/player.html`)}))}};var p=s(5673),h=s(1081);class u extends p.EventEmitter{ws;streamerServer;static nextId=100;status="ready";players=new Set;taskId=null;id;constructor(e,t){super(),this.ws=e,this.streamerServer=t;const s=this.id=(++u.nextId).toString();l.Z.debug(`streamer ${s} connected`),e.on("message",(e=>{var t;try{t=JSON.parse(e)}catch(t){return console.error(`cannot parse Streamer message: ${e}\nError: ${t}`),void this.destroy()}l.Z.debug(`streamer ${s} message: ${e}`);try{switch(t.type){case"ping":this.send({type:"pong",time:t.time});break;case"offer":case"answer":case"iceCandidate":this.sendToPlayer(t),l.Z.debug(`forwarded ${t.type} to player, ${JSON.stringify(t)}`);break;case"disconnectPlayer":this.removePlayer(t.playerId);break;default:l.Z.error(`unsupported Streamer message type: ${t.type}`),this.destroy()}}catch(e){l.Z.error(`ERROR: ws.on message error: ${e?.message}`)}})),e.on("close",((e,t)=>{const r=`streamer ${s} disconnected: ${e} ${t}}`;l.Z.debug(r),this.destroy(r)})),e.on("error",(t=>{l.Z.debug(`player ${s} connection error: ${t}`),e.close(1006,t.message),this.destroy(`player ${s} connection error: ${t}`)}))}send(e){const t=JSON.stringify(e);l.Z.info(`send message to streamer ${this.id} ${e.type} ${t}`),this.ws.send(t)}addPlayer(e){this.players.add(e),this.status="useing"}delPlayer(e){this.players.delete(e),0===this.players.size&&(this.status="used",this.destroy())}sendToPlayer(e){let t=e.playerId;t&&"number"==typeof t&&(t=t.toString()),delete e.playerId,this.players.forEach((s=>{t&&s.id,s.send(e)}))}removePlayer(e){this.players.forEach((t=>{t.id===e&&(t.destroy(),this.players.delete(t))}))}destroy(e=void 0){this.players.forEach((e=>e.destroy())),this.ws.close(),this.emit("destroy",{id:this.id,status:this.status,msg:e})}}class y extends p.EventEmitter{config;streamers=new Map;constructor(e,t){super(),this.config=t;const s=new h.u9({port:e});l.Z.info(`StreamerServer listening on port ${e}`),s.on("connection",((e,t)=>{const s=new u(e,this),r=new URLSearchParams(t.url?.split("?")[1]);r.has("taskId")&&(s.taskId=r.get("taskId")||null),this.streamers.set(s.id,s);const{peerConnectionOptions:i}=this.config;s.send({type:"config",peerConnectionOptions:i}),s.on("destroy",(()=>{this.streamers.delete(s.id),this.emit("streamerDestroy",{id:s.id,taskId:s.taskId,playersCount:s.players.size})})),this.emit("streamerConnection",s)}))}getReadyStreamers(){return[...this.streamers.values()].filter((e=>"ready"===e.status))}sendStreamersList(e){const t=[...this.streamers.keys()];e.send({type:"streamerList",ids:t})}hasStreamerByTaskId(e){return[...this.streamers.values()].some((t=>t.taskId===e))}removeStreamer(e){const t=this.streamers.get(e);t&&(t.destroy(),l.Z.info(`destroy streamer ${t.id}`),this.streamers.delete(e))}stats(){return[...this.streamers.values()].map((({id:e,status:t,taskId:s,players:r})=>({id:e,status:t,taskId:s,playerIds:[...r.values()].map((e=>e.id))})))}}var f=s(6489);class m extends p.EventEmitter{ws;static nextId=100;streamer=null;status="online";leaveTime=null;id;constructor(e){super(),this.ws=e;const t=this.id=(++m.nextId).toString();l.Z.debug(`player ${t} connected`),this.init()}init(){const e=this.ws,t=this.id;e.on("message",(s=>{var r;try{r=JSON.parse(s)}catch(r){return console.error(`cannot parse player ${t} message: ${s}\nError: ${r}`),e.close(1008,"Cannot parse"),void this.destroy()}if(r&&r.type)switch(l.Z.debug(`player ${t} message: ${s}`),r.type){case"ping":this.send({type:"pong",time:r.time});break;case"offer":case"answer":case"iceCandidate":case"dataChannelRequest":case"peerDataChannelsReady":r.playerId=t,this.sendToStreamer(r);break;case"listStreamers":case"subscribe":break;case"stats":l.Z.info(`player ${t}: stats\n${r.data}`);break;default:return l.Z.error(`player ${t}: unsupported message type: ${r.type}`),e.close(1008,"Unsupported message type"),void this.destroy()}else console.error(`Cannot parse message ${s}`)})),e.on("close",(e=>{l.Z.info(`player ${t} disconnected: ${e}`),this.status="offline",this.leaveTime=(new Date).getTime()})),e.on("error",(s=>{l.Z.error(`player ${t} connection error: ${s}`),e.close(1006,s.message),this.status="offline",this.leaveTime=(new Date).getTime()}))}reConnect(e){this.ws.readyState!==h.XY.CLOSED&&this.ws.close(1e3,"Reconnect"),this.status="online",this.leaveTime=null,this.ws=e,l.Z.info(`player ${this.id} reconnected`),this.init()}setStreamer(e){this.streamer=e,this.status="online"}send(e){const t=JSON.stringify(e);l.Z.info(`send message to player ${this.id} ${e.type} ${t}`),this.ws.send(t)}sendToStreamer(e){this.streamer?(l.Z.debug(`player ${this.id} send to streamer ${this.streamer.id} ${e.type}`),this.streamer.send(e)):l.Z.error(`player ${this.id} send to streamer: no streamer, message info: ${e}`)}destroy(){this.ws.readyState!==h.XY.CLOSED&&this.ws.close(),this.streamer&&this.streamer.delPlayer(this),this.status="destroyed",this.emit("destroy",this)}}class g extends p.EventEmitter{config;players=new Map;playersCookieId=new Map;ws;killer=null;constructor(e,t){super(),this.config=t;const s=this.ws=new h.u9({server:e});l.Z.info(`player server listening on port ${t.httpPort}..}`),s.on("connection",((e,t)=>{if("/stats"===t.url)return void this.emit("subscribeStats",e);const s=t.headers.cookie;if(s){const t=f.parse(s).renderId;if(t){let s=this.getPlayerByCookieId(t);if(s){const r=new m(e);s.streamer&&(r.setStreamer(s.streamer),s.streamer.addPlayer(r)),this.players.set(r.id,r),this.playersCookieId.set(t,r.id),s=r}else s=new m(e),this.players.set(s.id,s),this.playersCookieId.set(t,s.id),s.on("destroy",(e=>{this.removePlayer(e.id)}));const{peerConnectionOptions:r}=this.config;return s.send({type:"config",peerConnectionOptions:r}),void this.emit("playerConnection",s)}}e.close(1008,"No cookie")})),this.runKill()}getWaitPlayers(){return[...this.players.values()].filter((e=>"waitStreamer"===e.status))}getPlayerByCookieId(e){const t=this.playersCookieId.get(e);return t&&this.players.has(t)?this.players.get(t):null}sendToPlayer(e,t){const s=this.players.get(e);if(!s)return void l.Z.error(`dropped message ${t.type} as the player ${e} is not found`);const r=JSON.stringify(t);l.Z.info(`send message to player ${e} ${t.type} ${r}`),s.send(t)}removePlayer(e){const t=this.players.get(e);t&&"destroyed"!==t.status&&t.destroy(),this.players.delete(e)}runKill(){this.killer&&clearTimeout(this.killer),this.killer=setInterval((()=>{const e=(new Date).getTime(),t=this.config.playerTimeout;for(const s of this.players.values())"offline"===s.status&&null!==s.leaveTime&&e-s.leaveTime>1e3*t&&(l.Z.info(`player ${s.id} timeout`),this.removePlayer(s.id))}),1e3)}stopKill(){this.killer&&(clearInterval(this.killer),this.killer=null)}stats(){return[...this.players.values()].map((({id:e,status:t,streamer:s})=>({id:e,status:t,streamerId:s?.id})))}}class k{id;render;status;info={};createTime;constructor(e,t,s="starting"){this.id=e,this.render=t,this.status=s,this.createTime=(new Date).getTime()}kill(){"killing"!==this.status&&(this.status="killing",this.render.send({type:"killTask",taskId:this.id}))}setTaskInfo(e){this.info=e}setStatus(e){this.status=e}destroy(){}}class v extends p.EventEmitter{ws;status="offline";static nextId=100;static nextTaskId=100;id;tasks=new Map;states;gpuInfo;processInfo;info={gpuCount:0,maxInstance:0,taskCount:0,platform:"unknow"};constructor(e){super(),this.ws=e,this.id=(++v.nextId).toString(),this.status="online",e.on("message",(t=>{let s;try{s=JSON.parse(t)}catch(s){return console.error(`cannot parse render ${this.id} message: ${t}\nError: ${s}`),e.close(1008,"Cannot parse"),void this.destroy()}if(s&&s.type)switch(l.Z.debug(`render ${this.id} message: ${t}`),s.type){case"ping":this.send({type:"pong",time:s.time});break;case"renderConfig":this.info=s.data;break;case"taskCreated":this.tasks.has(s.taskId)&&this.tasks.get(s.taskId)?.setStatus("started");break;case"taskRejected":if(this.tasks.has(s.taskId)){const e=this.tasks.get(s.taskId);e.setStatus("killed"),e.destroy(),this.tasks.delete(s.taskId)}break;case"taskKilled":if(this.tasks.has(s.taskId)){const e=this.tasks.get(s.taskId);e.setStatus("killed"),e.destroy(),this.tasks.delete(s.taskId)}break;case"taskDie":if(this.tasks.has(s.taskId)){const e=this.tasks.get(s.taskId);e.setStatus("killed"),e.destroy(),this.tasks.delete(s.taskId)}break;case"gpuInfo":this.gpuInfo=s.data;break;case"stats":this.states=s.data,l.Z.info(`render ${this.id}: stats\n${s.data}`);break;default:return void l.Z.error(`render ${this.id}: unsupported message type: ${s.type}`)}else console.error(`Cannot parse message ${t}`)})),e.on("error",(e=>{l.Z.error(`render ${this.id} error: ${e}`),this.destroy()})),e.on("close",((e,t)=>{l.Z.info(`render ${this.id} close: ${e} ${t}`),this.destroy()}))}send(e){const t=JSON.stringify(e);l.Z.info(`send message to Render ${this.id} ${e.type} ${t}`),this.ws.send(t)}createTask(){const e=(++v.nextTaskId).toString();return this.tasks.set(e,new k(e,this)),this.send({type:"createTask",taskId:e}),e}killTask(e){const t=this.tasks.get(e);t&&"killed"!==t.status&&"killing"!==t.status&&(l.Z.debug(`kill Task id: ${t.id} status: ${t.status}`),t.kill())}get capacity(){return this.info.maxInstance-this.tasks.size||0}destroy(){this.tasks.forEach((e=>this.killTask(e.id))),this.ws.readyState!==h.XY.CLOSED&&this.ws.close(),this.emit("destroy")}}class w extends p.EventEmitter{config;renders=new Map;constructor(e,t){super(),this.config=t;const s=new h.u9({port:e});l.Z.info(`RenderServer listening on port ${e}`),s.on("connection",((e,t)=>{const s=new v(e);this.renders.set(s.id,s),this.emit("renderConnection",s),l.Z.info(`new render ${s.id} connected`),s.on("destroy",(()=>{this.renders.delete(s.id),this.emit("renderDestroy")}))}))}createTask(){const e=this.getRenderWithCapacity();if(e){return e.createTask()}return null}getRenderWithCapacity(){let e=null;for(const t of this.renders.values())console.log(t.capacity),t.capacity>0&&(!e||t.capacity>e.capacity)&&(e=t);return e}getRender(e){return this.renders.get(e)}getRenders(){return this.renders.values()}killTask(e){this.renders.forEach((t=>t.killTask(e)))}getTasks(){const e=[];return this.renders.forEach((t=>e.push(...t.tasks.values()))),e}get capacity(){let e=0;return this.renders.forEach((t=>e+=t.capacity)),e}stats(){return[...this.renders.values()].map((({id:e,status:t,capacity:s,info:r,gpuInfo:i,processInfo:a,states:n,tasks:o})=>({id:e,status:t,capacity:s,...r,gpuInfo:i,processInfo:a,states:n,tasks:[...o.values()].map((e=>({id:e.id,status:e.status})))})))}}var S=s(6269);const $=(0,S.loadConfig)(),I=Object.assign({},S.defaultConfig,$),{httpHost:T,httpPort:b,preLunchInstance:C,streamerPort:x,renderServerPort:E}=I,O=new c(I),Z=new y(x,I),P=new w(E,I),N=new g(O.http,I);Z.on("streamerConnection",(e=>{const t=N.getWaitPlayers();if(t.length>0){const s=t.shift();s.setStreamer(e),e.addPlayer(s),s.sendToStreamer({type:"playerConnected",playerId:s.id,dataChannel:!0,sfu:!1})}l.Z.info(`streamer ${e.id} ${e.status} connected`)})),Z.on("streamerDestroy",(({taskId:e,playersCount:t})=>{e&&t<=0&&P.killTask(e)})),N.on("playerConnection",(e=>{const t=Z.getReadyStreamers();if(t.length>0&&null===e.streamer){const s=t.shift();e.setStreamer(s),s.addPlayer(e),e.sendToStreamer({type:"playerConnected",playerId:e.id,dataChannel:!0,sfu:!1})}else null!==e.streamer?e.sendToStreamer({type:"playerConnected",playerId:e.id,dataChannel:!0,sfu:!1}):(P.createTask(),e.status="waitStreamer");console.log(`player ${e.id} ${e.status} connected`)})),setInterval((function(){const e=Z.getReadyStreamers(),t=N.getWaitPlayers(),s=P.capacity,r=C-e.length+t.length,i=Math.min(r,s);if(i)for(let e=0;e<i;e++)P.createTask()}),1e4),setInterval((function(){const e=P.getTasks(),t=(new Date).getTime();e.forEach((e=>{t-e.createTime>3e4&&!1===Z.hasStreamerByTaskId(e.id)&&P.killTask(e.id)}))}),5e3),O.app.get("/api/stats",((e,t)=>{t.send({player:N.stats(),streamer:Z.stats(),render:P.stats()})}));const R=new Set;setInterval((()=>{const e=N.stats(),t=Z.stats(),s=P.stats();R.forEach((r=>{r.send(JSON.stringify({type:"player",player:e})),r.send(JSON.stringify({type:"streamer",streamer:t})),r.send(JSON.stringify({type:"render",render:s}))}))}),1e3),N.on("subscribeStats",(e=>{R.add(e),e.on("close",(()=>{R.delete(e)}))}))}};